<credentialConfig>

	<metadata title="Authentx Card Defintion PIV-I" />

	This card definition is intended to be used in conjunction with card update.
	The configuration here is a partial creation of the required data objects.
	The remainder objects and some of these are created/updated, and re-signed
	in the associated carddef-update XML file when the token is encoded.


	<ConnectionSettings host="localhost" port="8389" userdn="" password="" />

	<dataSource>

		<authentxRoot>
			<dataitem name="edn" attr="edn" multi="no" />
			<dataitem name="cdn" attr="cdn" multi="yes" />
			<!-- dataitem name="pdn" attr="pdn" multi="yes" /-->
		</authentxRoot>

		<dataObject name="root" link="root" objclass="credential">
			<dataitem name="edn" attr="edn" multi="no" />
		</dataObject>

		<dataObject name="entity" link="edn" objclass="entity">

			<dataitem name="dob" attr="dob" />
			<dataitem name="eid" attr="eid" />
			<dataitem name="eyeclr" attr="eyeclr" />
			<dataitem name="first" attr="firstname"/>
			<dataitem name="hght" attr="hght"/>
			<dataitem name="hrclr" attr="hrclr"/>
			<dataitem name="last" attr="lastname" />
			<dataitem name="mi" attr="mi" />
			<dataitem name="nationality" attr="nationality" />
			<dataitem name="suffix" attr="suffix" />
			<dataitem name="sponsor" attr="sponsor"/>
			<dataitem name="ediident" attr="ediident"/>
			<dataitem name="upn" attr="upn"/>

		</dataObject>

		<dataObject name="entity.entitybranchname" link="edn" objrdn="sysid=entitybranchname" objclass="xsystem">

			<dataitem name="agency" attr="sysval"/>

		</dataObject>


		<dataObject name="entity.general" link="edn" objrdn="gcoid=general" objclass="gco">

			<dataitem name="data" attr="xblk" multi="yes" >
				<xblkinfo
					x002502="affiliation"
					x002355="agencyrole"
					x002356="agencytext"
					/>
			</dataitem>

		</dataObject>

		<dataObject name="card.data" link="edn" objrdn="gcoid=token,procid=token,ounit=pivi" objclass="gco" modify="no">

			<dataitem name="cardpin" attr="upin" />
			<dataitem name="data" attr="xblk" multi="yes" >
				<!-- x000031="cardpin" old location -->
				<xblkinfo
					x002091="upnextension"
					x0020c3="upn"
					x002336="accesspin"
					x000053="expdate"
					x000052="issdate"
					x00207b="changedate"
					x002055="cardpickup"
					x002081="lawenfrcment"
					x002082="propertypass"
					x002083="childcare"
					x0020c5="emergencyresp"
					x002335="issueby"
					x002521="specdesignation"
					x000054="cardtype"
					x002301="clearance"
					x002087="issreason"
					x0020c6="ctopo" />

					<!--
					x002073="agencycode"
					x002074="systemcode"
					x002075="crednum"
					x002076="credseries"
					x002311="btype"
					x002341="reason"
					x002377="ici"
					-->
			</dataitem>

		</dataObject>

	</dataSource>

	<dataTarget format="credential_xblk" return="dn">

		<authentxRoot>
			<dataitem name="cdn" attr="cdn" multi="yes" />
		</authentxRoot>

			<!--
 			IF action=update, the targetRoot is built, but not actually updated.  Allows save=yes
			to be used to capture an existing value.
			-->

		<targetRoot link="cdn" id="cid" objclass="credential" >

			<copyitem type="attr" name="issby" source="entity:sponsor" />
			<copyitem type="attr" name="ctype" value="" />
			<copyitem type="attr" name="desc" value="AuthentX PIV-I Card" />
			<copyitem type="attr" name="rem" value="version=2" />
			<copyitem type="attr" name="status"	value="piviPending" />
			<copyitem type="attr" name="action"	value="PrintEncode" /> <!-- or Export -->
			<copyitem type="attr" name="tokenclass" value="pivi" />
			<copyitem type="attr" name="tokentype" value="pivi" />
            <copyitem type="attr" name="issreason"  source="card.data:issreason"  /> <!-- default="new" -->

			<copyitem type="ref" name="defaultexpdate" process="expdate[,,2190]" save="yes" />
			<copyitem type="ref" name="expdate" source="card.data:expdate" altsource="me:defaultexpdate" process="substr[0,8]" save="yes" />
			<copyitem type="ref" name="issdate" process="datestamp" save="yes" />

			<copyitem type="attr" name="expdate" source="me:expdate" process="ldapdate" />
			<copyitem type="attr" name="issdate" source="me:issdate" process="ldapdate" />

			<datagroup name="objlog" attr="objectlog" type="calculated" process="concat">
				<groupitem value="object created at "/>
				<groupitem process="timestamp" />
			</datagroup>

			<copyitem type="attr" name="cardtopology" source="card.data:ctopo" altsource="cardCredential:ctopo"/>
			<copyitem type="attr" name="ctype" source="card.data:cardtype" altsource="cardCredential:cardtype"/>
			<copyitem type="ref" name="uuid" process="getuuid[bin]" save="yes" />
			<copyitem type="attr" name="cuid" source="me:uuid" process="bin2hex" save="yes" />

			<datagroup name="fascn" type="calculated" process="calcfascn" multi="no" save="yes" >
				<groupitem name="agency" 		value="9999" />
				<groupitem name="system" 		value="9999" />
				<groupitem name="credential"	value="999999" />
				<groupitem name="series" 		value="0" />
				<groupitem name="issnum" 		value="1" />
				<groupitem name="edipi" 		value = "0000000000"  />
				<groupitem name="orgcat" 		value="3"  />
				<groupitem name="orgid" 		value = "0000" />
				<groupitem name="poassoc" 		source="entity.general:affiliation"  process="getpoacode"  />
			</datagroup>

			<copyitem type="alias" source="me:uuid" process="bin2hex" prefix="CUI" />

		</targetRoot>

		<targetObject name="card" objrdn="gcoid=card" objclass="gco" id="gcoid" modify="no">

			<copyitem type="ref" name="cardpin" process="rand[100001,999999]" save="yes"/>

			<copyitem type="attr" name="objtype" value="ref" />
			<copyitem type="attr" name="upin" source="card.data:cardpin" altsource="me:cardpin" />
			<copyitem type="xblk" tag="0031"  source="card.data:cardpin" altsource="me:cardpin" />
			<copyitem type="xblk" tag="2055" source="card.data:cardpickup" />
			<copyitem type="xblk" tag="2336" source="card.data:accesspin" />

			<copyitem type="xblk" tag="2081" source="card.data:lawenfrcment" default="No" />
			<copyitem type="xblk" tag="2082" source="card.data:propertypass" default="No" />
			<copyitem type="xblk" tag="2083" source="card.data:childcare" default="No" />
			<copyitem type="xblk" tag="20c5" source="card.data:emergencyresp" default="No" />
			<copyitem type="xblk" tag="2521" source="card.data:specdesignation" />
			<copyitem type="xblk" tag="2305" source="card.data:clearance" />

		</targetObject>


		<targetObject name="cardcap" objrdn="gcoid=A000000308.5fc107" objclass="gco" id="gcoid" format="stupid_ber;piv_der[5C035FC107,53]" >

			<copyitem type="attr" name="fid" 		value="A000000308.5FC107" />
			<copyitem type="attr" name="objtype" 	value="dat" />

			<datagroup name="cardid" tag="f0" attr="xblk" type="calculated" process="concat;hex2bin" >
				<groupitem name="rid" value="A000000308" />
				<groupitem name="cardid" source="targetroot:objdn" process="getcid" />
			</datagroup>

			<copyitem type="xblk" tag="f1" name="cccver" 	value="21" process="hex2bin"  />
			<copyitem type="xblk" tag="f2" name="gramver" 	value="21" process="hex2bin" />

			<datagroup  name="appurl" tag="f3" attr="xblk" type="calculated" process="concat;hex2bin" multi="no" >
				<groupitem value="F310A00000030801C1070000000000000000"  />
				<groupitem value="F310A00000030801C1020000000000000000"  />
				<groupitem value="F310A00000030801C1030000000000000000"  />
				<groupitem value="F310A00000030801C1090000000000000000"  />
				<!-- <groupitem value="F310A00000030801C1080000000000000000" /> -->
				<groupitem value="F310A00000030801C1060000000000000000"  />
				<groupitem value="F310A00000030801C1050000000000000000"  />
			</datagroup>

			<copyitem type="xblk" tag="f4" name="pkcs15flag" 	value="00" process="hex2bin" />
			<copyitem type="xblk" tag="f5" name="dataver" 	value="10"  process="hex2bin" />

			<copyitem type="xblk" tag="f6" name="acrtable" 	value="0000000000000000000000000000000000" process="hex2bin" />
			<copyitem type="xblk" tag="f7" name="cardapdu" 	value="" />
			<copyitem type="xblk" tag="fa" name="rediflag" 	value="" />
			<copyitem type="xblk" tag="fb" name="cardtuples" 	value="" />
			<copyitem type="xblk" tag="fc" name="statustuples" 	value="" />
			<copyitem type="xblk" tag="fd" name="nextcc" 	value="" />

		</targetObject>

		<targetObject name="chuid" objrdn="gcoid=A000000308.5fc102" objclass="gco" id="gcoid" format="stupid_ber;piv_der[5C035FC102,53]" >

			<copyitem type="attr" name="fid" 		value="A000000308.5fc102" />
			<copyitem type="attr" name="objtype" 	value="dat" />

			<copyitem type="xblk" tag="30" source="me:fascn" /><!-- FASCN -->
			<copyitem type="xblk" tag="34" name="guid" source="me:uuid" /><!-- guid=cuid -->
			<copyitem type="xblk" tag="35" name="expdate" source="me:expdate"/>

			<datagroup name="chuidsdo" tag="3e" attr="xblk" type="calculated" process="stupid_ber[,addtag];chuid_sig" multi="no" > chuid_sig or cms_sig[,softkey,chuid]
				<groupitem  name="30" source="me:fascn" />
				<groupitem  name="34" source="me:uuid"  />
				<groupitem  name="35" source="me:expdate" />
			</datagroup>

		</targetObject>

		<targetObject name="printedinfo" objrdn="gcoid=A000000308.5fc109" objclass="gco" id="gcoid" format="stupid_ber;piv_der[5C035FC109,53]" >

			<copyitem type="attr" name="fid" 		value="A000000308.5fc109" />
			<copyitem type="attr" name="objtype" 	value="dat" />

			<datagroup name="fullname" tag="01" attr="xblk" type="calculated" process="concat;allcaps" multi="no" >
				<groupitem name="first" source="entity:first" />
				<groupitem value=" " />
				<groupitem name="mi" source="entity:mi"/>
				<groupitem value=" " />
				<groupitem name="last" source="entity:last"/>
			</datagroup>

			<copyitem type="xblk" tag="02" source="entity.general:affiliation" />
			<copyitem type="xblk" tag="04" source="me:expdate" process="yyyymmmdd" />

		</targetObject>

		<targetObject name="secobj" objrdn="gcoid=A000000308.5fc106" objclass="gco" id="gcoid" modify="process" >
		
			This element invokes a separate anormal process that reads the indicated container objects, 
			computes the hash values, signs the constructed sdo, and updates the security-object 
			container object.  The groupitem names correspond to the hash map specified in FIPS 201.
			Missing objects are ignored and are not included in the security hash.

			<datagroup name="secobj_sig" type="calculated" process="secobj_update[softkey]" >
				<groupitem name="targetrootdn" source="targetroot:objdn" />
				<groupitem name="01DB00" value="5FC107" />	Card Capability 5FC107
				<groupitem name="023001" value="5FC109" />	Printed Info 5FC109
				
				<!-- gn = group-number
				<groupitem name="gn3000" value="5FC102" />	CHUID 5FC102
				<groupitem name="gn6010" value="5FC103" />	Fingerprint 5FC103
				<groupitem name="gn0101" value="5FC105" />	PIV Cert 5FC105
				<groupitem name="gnDB00" value="5FC107" />	Card Capability 5FC107
				<groupitem name="gn6030" value="5FC108" />	Facial Image 5FC108
				<groupitem name="gn3001" value="5FC109" />	Printed Info 5FC109

				<groupitem name="gn0100" value="5FC10A" />  Digital Sig Cert 5FC10A
				<groupitem name="gn0102" value="5FC10B" />  Key Mgmt Cert 5FC10B
				<groupitem name="gn0500" value="5FC101" />  Card Auth Cert 5FC101
				
				<groupitem name="gn6060" value="5FC10C" />  Key History Object
				-->
			</datagroup>

		</targetObject>

		<targetObject name="topoinfo" objrdn="gcoid=topoinfo" objclass="gco" id="gcoid">

			<copyitem type="attr" name="objtype" 	value="ref"  />
			<copyitem type="xblk" tag="002101" source="entity:first" /><!-- nameline1 -->
			<copyitem type="xblk" tag="002102" source="entity:last" process="concat;allcaps" /><!-- nameline2 -->

			<datagroup name="fullname" tag="99010b" attr="xblk" type="calculated" process="concat;allcaps" multi="no" >
				<groupitem name="first" source="entity:first" />
				<groupitem value=" " />
				<groupitem name="mi" source="entity:mi"/>
				<groupitem value=" " />
				<groupitem name="last" source="entity:last"/>
			</datagroup>

			<datagroup name="firstandmi" tag="990104" attr="xblk" type="calculated" process="concat;allcaps" multi="no" >
				<groupitem name="first" source="entity:first" />
				<groupitem value=" " />
				<groupitem name="mi" source="entity:mi" process="substr[0,1]" />
			</datagroup>

                        <datagroup name="lastnamesuffix" tag="991014" attr="xblk" type="calculated" process="concat;allcaps" multi="no" >
                                <groupitem name="last" source="entity:last" />
                                <groupitem value=" " />
                                <groupitem name="suffix" source="entity:suffix" />
                        </datagroup>

			<copyitem type="xblk" tag="99000a" source="me:crdnum" />
			<copyitem type="xblk" tag="990101" source="me:crdnum" />
			<copyitem type="xblk" tag="990102" source="me:expdate" process="mmyy" />
			<copyitem type="xblk" tag="990202" source="me:expdate" process="yyyymmmdd" />
			<copyitem type="xblk" tag="990302" source="me:expdate" process="mmmyyyy" />
			<copyitem type="xblk" tag="990105" source="me:issdate" process="yyyymmmdd"/>

			<copyitem type="xblk" tag="990006" source="entity:hght" />
			<copyitem type="xblk" tag="990007" source="entity:hrclr" />
			<copyitem type="xblk" tag="990008" source="entity:eyeclr" />

			<copyitem type="xblk" tag="002039" source="me:fascn" process="unpackseiwg" />
			<copyitem type="xblk" tag="002073" source="me:agency" />
			<copyitem type="xblk" tag="002074" source="me:system" />
			<copyitem type="xblk" tag="002075" source="me:crednum" />

			<copyitem type="xblk" tag="990205" source="entity.entitybranchname:agency" />
			<copyitem type="xblk" tag="002502" source="entity.general:affiliation" />
			<copyitem type="xblk" tag="002521" source="card.data:specdesignation" />
			<copyitem type="xblk" tag="002355" source="entity.general:agencyrole" />
			<copyitem type="xblk" tag="002356" source="entity.general:agencytext" />

			<!-- Flags -->
			<copyitem type="xblk" tag="990204" name="region" source="root:edn" process="getxid2[region]" />
			<copyitem type="xblk" tag="002081" source="card.data:lawenfrcment" default="N" process="substr[0,1]"/>
			<copyitem type="xblk" tag="002082" source="card.data:propertypass" default="N" process="substr[0,1]"/>
			<copyitem type="xblk" tag="002083" source="card.data:childcare" default="N" process="substr[0,1]"/>
			<copyitem type="xblk" tag="0020c5" source="card.data:emergencyresp" default="N" process="substr[0,1]"/>

		</targetObject>

		<targetObject name="objectlog" objrdn="sysid=logs" objclass="xsystem" id="sysid">
			<datagroup name="objlog" attr="objectlog" type="calculated" process="concat">
				<groupitem value="Object created during enrollment at "/>
				<groupitem process="timestamp" />
			</datagroup>
		</targetObject>

	</dataTarget>

</credentialConfig>
